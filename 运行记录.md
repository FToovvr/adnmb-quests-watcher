# 运行记录

## 2021-04-30 部分串的预览被「大金天」串夺舍

* 状态：尚不知晓原因
* 优先级：低（此情况应该不会很容易发生）

略

部分信息见 >>No.37633418。

## 2021-05-04 尚存的串被标为「已消失」

* 状态：已知晓原因，尚未修复
* 优先级：中

略

部分信息见 >>No.37633418。

## 2021-05-09 采集遗漏/持续崩溃

* 状态：尚不知晓原因
* 优先级：高

10 号凌晨偶然想提前看下趋势榜，使用 SQL 代码进行查询时[^1]，
发现当日新发布的主题串 37676908 采集到的回应量要比服务器标注的回应量少，
显然表明该串的采集工作存在遗漏。\
检查发现，数据库中缺少了该串从 20:31:40 往后至 21:12:53 往前的 10+ 回应。\
目前尚不明确是否有其他串也存在遗漏。

为了调查前述情况阅读日志，发现从 12:40，即手动导入过的主题串 28470905 浮上起，
每次采集任务都会在靠近结尾的时候崩溃，不过在该串回应时间之后的其他串的新回应仍然会录入数据库中。\
遗漏现象很可能与此事有关。

导致崩溃的原因是手动导入的串的 `effective_at_least_from` 字段为 `NULL`，而如果串首内容发生变化（比如加上了标记完结的蓝字），记录串首的旧版本时该字段不能为 `NULL`。\
已通过 workaround 解决了崩溃问题（`COALESCE(thread.effective_at_least_from, '0001-01-01 00:00:00+0'::timestamptz)`），采集工作从次日 1:00 起恢复正常，但这明显不是最终解决方案。

另外，观察 `activity` 表发现，持续崩溃期间串页面的请求次数随时间单调递增。\
这很奇怪，因为按理说如果发现预览里的回应都已经存在于数据库中，正常应该会直接跳过该主题串，而不是再深入串内进行扫描。\
版块页面也应该同理。\
而尽管有重复扫描，还是发生了先前提到的遗漏。

[^1]: 
``` sql
SELECT RANK() OVER (ORDER BY increased_response_count DESC), thread.user_id, get_daily_threads_report.*
FROM get_daily_threads_report('2021-05-09 04:00+8', '2021-05-10 04:00+8')
LEFT JOIN thread ON get_daily_threads_report.id = THREAD.id;
```

### 影响

* 遗漏了回应；
* 从服务器下载了是正常情况的将近 10 倍的数据（6.5MB vs 65MB）

### 后续工作

* [ ] 编写脚本重新扫描崩溃期间有新回应的串，以补上遗漏的回应；
* [ ] 详细分析日志；
* [ ] 检查可能存在问题的代码：
    * …